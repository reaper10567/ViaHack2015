<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<link href='https://fonts.googleapis.com/css?family=Coming+Soon' rel='stylesheet' type='text/css'>
 	<title>Derpmaster's Awesome Product Search of Awesome of BestBuy&trade;</title>
 	<style>
 	*{
 		font-family: 'Coming Soon', sans-serif;
 	}
 	body{
		background-color:#BF607B;
	}
 	h1{
 		color:#e4685d;
		text-align: center;
		font-size: 50px;
		padding: 30px 0 0 10px;
		background-image: url(http://people.rit.edu/tcg3234/330/dood.jpg);
		background-repeat: no-repeat;
		background-size:cover;
		background-position: 0 -230px;
		height:200px;
		width:800px;
 	}
 	
 	.eventDiv{
 		border-bottom:1px solid gray;
 		margin-bottom:2em;
 	}
 	
 	#content{
 		margin-left: 15%;
 		margin-right:15%;
 		background-color:#E599AF;
 		min-height:500px;
 		padding:0 10px 10px 10px;
 		border:1px solid gray;
 	}
 	
 	#search{
 		box-shadow:inset 0px 1px 0px 0px #f7c5c0;
 		background-color:#bf607B;
 		border-radius:6px;
 		border:1px solid #d83526;
 		display:inline-block;
 		cursor:pointer;
 		color:#4C0016;
 		font-size:15px;
 		font-weight:bold;
 		padding:6px 24px;
 		text-decoration:none;
 		text-shadow:0px 1px 0px #b23e35;
 		margin-right:2em;
 	}

 	
 	#search:hover {
 		background-color:#993350;
 	}

 	
 	#search:active {
 		position:relative;
 		top:1px;
 	}
	
	#map-div{
		margin:0;
		padding:0;
		width:542px;
		height:300px;
		border:1px solid black;
	}

 	
 	#searchterm{
 		font-size:16px;
 	}

 	
 	
 	</style>
	<!-- Import jQuery -->
  <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZHO-Xmei5wwVuNHkiw8HLzZKK7dPhXNA">
    </script>
  <script>
	"use strict";
		var BEST_BUY_URL = "https://api.remix.bestbuy.com/v1/stores(city="
		var BEST_BUY_URL1 = ")+products(name=";
		var BEST_BUY_URL2 = "*)?show=name,address,postalCode,city,region,lat,lng,products.addToCartUrl,products.name,products.image,products.inStoreAvailability,products&format=json&callback=eventJsonLoaded&apiKey=";
		var BEST_BUY_API_KEY = "e56vxn9bzu5s2ead9phxjspu";
		var RETURN_KEY = 13;
		var map;
		var infowindow;
		var markers = [];
	
		window.onload = init;
		
		function init(){
			document.querySelector("#search").onclick = doSearchForEvent;
			document.querySelector("#searchterm").onkeyup = doKeyup;
			
			var mapOptions = { center: { lat:39.828127, lng: -98.579404},zoom:3};
			map = new google.maps.Map(document.getElementById('map-div'),mapOptions);
		}
		
		 function addMarker(lat,lon,title){
		var pos = {lat: lat, lng: lon, title: title};
		var marker = new google.maps.Marker({position: pos, map: map});
		marker.setTitle(title);
		 google.maps.event.addListener(marker, 'click', function(e){
		makeInfoWindow(this.position, this.title);
		
	  });
	  markers.push(marker);
	  }
	  function clearMarkers(){
		if(infowindow) infowindow.close();
		
		for(var i=0; i < markers.length; i++)
		{
			markers[i].setMap(null);
		}
		markers=[];
		
	  }
	  function makeInfoWindow(position, msg){
		if(infowindow) infowindow.close();
		
		infowindow = new google.maps.InfoWindow({map: map, position: position, content: "<b>" + msg + "</b>"});
	  }
	  
	  function zoomOnFirstResult(allEvents){
		if(markers.length ==0) return;
		
		//console.log(Number(allEvents[0].venue.location["geo:point"]["geo:lat"]));
		var mapOptions = { center: { lat:Number(allEvents[0].lat), lng: Number(allEvents[0].lng)},zoom:12};
		map.setOptions(mapOptions);
	  }
		
		function doKeyup(e){
			if(e.keyCode == RETURN_KEY){
				doSearchForEvent();
			}
		}
		
		function doSearchForEvent(){
			// build up our URL string
			clearMarkers();
			var value = document.querySelector("#searchterm").value;
			var zip = document.querySelector("#zip").value;
			// get rid of any leading and trailing spaces
			value = encodeURI(value.trim()); 
			zip = encodeURI(zip.trim());
			if(value.length < 1 || zip.length <1)
			{
				return;
			}			
			var url = BEST_BUY_URL;
			url+=zip;
			url += BEST_BUY_URL1;
			url +=  value;
			url += BEST_BUY_URL2;
			url += BEST_BUY_API_KEY;
			
			// get value of form field
			
			
			// if there's no band to search then bail out of the function (return does this)
			
			document.querySelector("#dynamicContent").innerHTML = "<b>Searching for " + value + "</b>";
			
			// replace spaces the user typed in the middle of the term with %20
			// %20 is the hexadecimal value for a space
			
			
			// finally, add the artist name to the end of the string
			
			// call the web service, and download the file
			$("#dynamicContent").fadeOut(250);
			var s = document.createElement('script');
			s.type = "text/javascript";
			s.src = url;
			var h = document.getElementsByTagName('script')[0];
			h.parentNode.insertBefore(s,h);
		}
		
		
		function eventJsonLoaded(obj){
			console.log("obj = " +obj);
			console.log("obj stringified = " + JSON.stringify(obj));
			
			
			if(obj.error){ // this catches a bad API key, missing parameter, etc...
				var message = obj.message;
				document.querySelector("#dynamicContent").innerHTML = "<b>Error: " + message + "</b>";
				$("#dynamicContent").fadeIn(1000);
				return; // bail out
			}
			
			// otherwise, start parsing!
			
			var allEvents = obj.stores;
			var bigString = "Search results for " + document.querySelector("#searchterm").value + " in " + document.querySelector("#zip").value;

			/*
				If there is only one event, Last.fm returns a single object, NOT an
				array. This is really annoying behavior!
			*/
			if (!(allEvents instanceof Array)){
				allEvents = [allEvents]; // put the object in an array
			}
			if(allEvents.length <1)
			{
				bigString = "No results found";
			}		
			else{
			
				for (var i=0;i<allEvents.length;i++){
					var event = allEvents[i];
					
					var lat = Number(event.lat);
					var lng = Number(event.lng);
					var address = event.address;
					var city = event.city;
					var region = event.region;
					var zip = event.postalCode;
					address += ", "+city+", " + region + ", " + zip;
					if(lat && lng)
					{
						addMarker(lat,lng,address);
					}
					var products = event.products;
					var line = "<div class='eventDiv'>";
					line+="<h2>Store Address: " + address + "</h2>";
					line+= "<table width='1000'>";
					for(var j=0; j <  products.length; j++){
						var product = products[j];
						
						var name = product.name;
						var image = product.image;
						var available = product.inStoreAvailability;
						var buyURL = product.addToCartUrl;
						var availableString;
						if(available)
							availableString = "Yes";
						else
							availableString = "No";
						line += "<tr>"
						line += "<td>" + name + "<br>" + "<img src='" + image + "'></td>";
						line+= "<td>Available in store: " + availableString + "</td>"; 
						line += "<td><input id='search' type='button' value='Let Me Buy it!' onclick='window.open(\"" + buyURL + "\")'></td>";
						line+="</tr>";
					}
					// get a bunch of values*/
					line+= "</table>";
					line += "</div>";
					bigString += line;
					zoomOnFirstResult(allEvents);
				}
			}
			
			// update our UI
			document.querySelector("#dynamicContent").innerHTML = bigString;
			$("#dynamicContent").fadeIn(1000);
			
		}	
 
  
  </script>
</head>
<body>
<div align="center" id="content">
	<h1>Derpmaster's Search of Awesome of BestBuy!</h1>
	<p><i>Your awesome search for awesome stuff!</i></p>
	
	<div>
	<label>Enter a product name -&gt;</label> <input id="searchterm" type="text" size="20" maxlength="20" value="Stuff" autofocus /> 
	</div><div>
	<label>Enter City -&gt;</label> <input id="zip" type="text" size="31" maxlength="31" value="Rochester" autofocus/>
	</div>
	<button type="button" id="search">Find Products!<br>:D<br>DO IT NAO</button>
	<h2>Search Results</h2>
	<div id="map-div"></div>
	<div id="dynamicContent">
		<p>No data yet!</p>
	</div>
</div>

</body>
</html>
